#!/usr/bin/env perl
use warnings;
use strict;
use feature qw(say switch);
use Git;
use Getopt::Long;
use Git::Release;

my $manager = Git::Release->new;
$|++;

my $branch = shift;

my $cb = $manager->get_current_branch;
$cb->move_to_ready;

__END__
=pod

Move branch to ready/

=cut
# my $version = Git::command_oneline('version');
my $working_dir = getcwd();
my $repo = Git->repository ( WorkingSubdir => $working_dir );
my $ref = $repo->command( 'symbolic-ref' , 'HEAD' );
chomp($ref);
my $branch = $ref;
$branch =~ s{^refs/heads/}{};
my $ready_prefix ||= $repo->config('release.ready-prefix') || 'ready/';


die('skipped') if $branch eq 'master'
            || $branch =~ m/^$ready_prefix/;

my $new_branch = $ready_prefix . $branch;

# Updating remote & prune branches
# $repo->command( 'remote' , 'update' , '--prune' );
$repo->command( 'branch' , '-m' , $branch , $new_branch );

for( split /\n/,$repo->command( 'remote' ) ) {
    $repo->command( 'push' , $_ , $branch , '--delete' );
    $repo->command( 'push' , $_ , $new_branch );
}
$repo->command( 'gc' , '--aggressive' , '--prune=now' );
