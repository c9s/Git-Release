#!/bin/bash
REMOTE=$1
REMOTE_NAME=$2
REPO=$(basename `pwd`)

if [[ -z $REMOTE ]] ; then
    echo <<END
    Usage: 

        git new-repo [remote host] [remote name]

END
    exit;
fi

if [[ -z $REMOTE_NAME ]]; then
    REMOTE_NAME=origin
fi

TF=.script-$RANDOM

cat <<END > $TF
if [[ -e /git/$REPO.git ]] ; then
    echo "Repository has been created."
    exit
fi
sudo mkdir /git/$REPO.git
cd /git/$REPO.git
sudo git init --bare 
cd ..
sudo chown -R git: $REPO.git
sudo chmod -R g+rw $REPO.git
cd 
rm $TF
END

scp $TF $REMOTE:
ssh $REMOTE "bash $TF"

if [[ -z `git remote | grep $REMOTE_NAME` ]] ; then
    echo "Adding remote $REMOTE_NAME => git@$REMOTE:/git/$REPO.git"
    git remote add $REMOTE_NAME git@$REMOTE:/git/$REPO.git
fi
echo "Pushing to remote $REMOTE_NAME"
git push $REMOTE_NAME master > /dev/null
rm $TF
echo "Done"
